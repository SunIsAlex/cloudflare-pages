<script defer=true src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<script>
// 确保页面已引入 marked.js 和 MathJax
// 示例引入方式（可放在 baseof.html footer 前）
// <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

document.addEventListener('DOMContentLoaded', () => {
  // 查找所有 term-modal-trigger
  document.querySelectorAll('.term-modal-trigger').forEach(trigger => {
    const modalId = trigger.dataset.modalId;
    const mdPath = trigger.dataset.mdPath;

    if (!modalId || !mdPath) return;

    trigger.addEventListener('click', (e) => {
      e.preventDefault();

      // 如果 modal 已存在，直接显示
      let modal = document.getElementById(modalId);
      if (modal) {
        modal.style.display = 'block';
        return;
      }

      // 创建 modal 结构
      modal = document.createElement('div');
      modal.id = modalId;
      modal.className = 'term-modal';
      modal.innerHTML = `
        <div class="term-modal-content">
          <span class="term-modal-close">&times;</span>
          <div class="term-modal-body">
            <div class="loading">加载中...</div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);

      const body = modal.querySelector('.term-modal-body');
      const closeBtn = modal.querySelector('.term-modal-close');

      // 关闭事件
      closeBtn.addEventListener('click', () => {
        modal.style.display = 'none';
      });

      modal.addEventListener('click', (ev) => {
        if (ev.target === modal) {
          modal.style.display = 'none';
        }
      });

      // fetch 原始 Markdown
      fetch(mdPath)
        .then(response => {
          if (!response.ok) {
            throw new Error(`文件加载失败：${response.status}`);
          }
          return response.text();
        })
        .then(mdText => {
          // 去除 front matter
          const cleanedMd = mdText.replace(/^---\n[\s\S]*?\n---\n?/m, '').trim();

          // 用 marked 转为 HTML
          const html = marked.parse(cleanedMd);

          // 插入 HTML
          body.innerHTML = html;
	alert(html);
          // 重要：让 MathJax 重新渲染新内容
          if (typeof MathJax !== 'undefined') {
            // MathJax v3
            MathJax.typesetPromise([body]).catch(err => {
              console.error('MathJax 渲染失败:', err);
            });
          } else if (MathJax && MathJax.Hub) {
            // MathJax v2 兼容
            MathJax.Hub.Queue(["Typeset", MathJax.Hub, body]);
          }
        })
        .catch(error => {
          body.innerHTML = `<p style="color: red; font-weight: bold;">加载失败：${error.message}</p>`;
          console.error(error);
        });

      // 显示 modal
      modal.style.display = 'block';
    });
  });
});
</script>
