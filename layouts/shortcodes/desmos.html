<div class="desmos-container" 
     id="desmos-{{ .Get "id" | default (printf "calc-%d" now.Unix) }}" 
     style="width:100%; height:500px; border:2px solid #ccc;"></div>
<script>
document.addEventListener('DOMContentLoaded',function() {
  function initDesmos() {
    if (typeof Desmos === 'undefined' || !Desmos.GraphingCalculator) {
      console.warn('Desmos not loaded yet, retrying...');
      setTimeout(initDesmos, 100);  // 或用 requestAnimationFrame
      return;
    }
    var elt = document.getElementById('desmos-{{ .Get "id" | default (printf "calc-%d" now.Unix) }}');
    if (!elt) return;

    var calculator = Desmos.GraphingCalculator(elt, {
      expressions: true,
      zoomButtons: true,
      expressionsTopbar: true
    });

    // ── 關鍵在這裡 ──
    var funcsStr = "{{ .Get "funcs" | strings.TrimSpace | safeJS }}";
    //var funcsStr = {{ .Get "funcs" | default "" | safeJS }};
    var funcs = funcsStr
      .split(/[\s\|\,]+/)           // 支持 |   ,   空格  甚至多行
      .map(s => s.trim())
      .filter(s => s.length > 0);

    var colors = ["#1f77b4", "#ff7f0e", "#2ca02c", "#d62728", "#9467bd", "#8c564b", "#e377c2", "#7f7f7f"];

    funcs.forEach(function(latex, i) {
      if (latex) {
        calculator.setExpression({
          id: 'f' + i,
          latex: latex,
          color: colors[i % colors.length]
        });
      }
    });

    calculator.setMathBounds({
      left:   {{ .Get "xmin" | default -10 }},
      right:  {{ .Get "xmax" | default 10 }},
      bottom: {{ .Get "ymin" | default -10 }},
      top:    {{ .Get "ymax" | default 10 }}
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initDesmos);
  } else {
    initDesmos();
  }
});
</script>
